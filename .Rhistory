world_aligned$id <- seq_len(nrow(world_aligned))
# Reclassify to binary vegetation indicator (1 for 10–200)
r_veg <- classify(r, rbind(c(-Inf, 10, 0), c(10, 200, 1), c(200, Inf, 0)))
z <- terra::zonal(r_veg, vect(world_aligned), fun = "mean", na.rm = TRUE)
frac <- rep(NA_real_, nrow(world_aligned))
frac[match(z$zone, world_aligned$id)] <- z$mean
tibble(country_iso = world_aligned$country_iso, vegetation_fraction = frac)
} else {
warning("Missing land cover raster: ", veg_path)
tibble(country_iso = world$country_iso, vegetation_fraction = NA_real_)
}
}, by = "country_iso") %>%
left_join(extract_stat(world, haz_path, fun = mean) %>% rename(hazard_score = value), by = "country_iso") %>%
mutate(
pm25_mean = NA_real_,             # placeholder
precip_mm_month = NA_real_        # placeholder
)
library(tidyverse)
library(readxl)
library(sf)
library(terra)
library(randomForest)
library(jsonlite)
theme_set(theme_minimal())
# Limit terra memory usage to ~80% of available
terraOptions(memfrac = 0.1, todisk = TRUE, parallel = FALSE)
lgii_default <- "data/Nasa Earth Data/spatialecon-lgii-measures-v1-xlsx.xlsx"
lgii_sample <- "data/sample/lgii_sample.csv"  # set use_sample_lgii <- TRUE only if testing
use_sample_lgii <- FALSE
kaggle_dir <- "data/Kaggle Dataset"   # adjust if your folder is named differently (e.g., 'data/Kaggle Data')
if (file.exists(lgii_default)) {
lgii_path <- lgii_default
} else if (use_sample_lgii && file.exists(lgii_sample)) {
lgii_path <- lgii_sample
} else {
stop("LGII Excel not found at ", lgii_default, ". Set the correct path or enable use_sample_lgii for the toy CSV.")
}
lgii_path <- normalizePath(lgii_path, winslash = "/", mustWork = TRUE)
kaggle_dir <- normalizePath(kaggle_dir, winslash = "/", mustWork = TRUE)
cat("Using LGII at:", lgii_path, "\n")
cat("Using Kaggle data at:", kaggle_dir, "\n")
standardize_iso <- function(x) toupper(trimws(as.character(x)))
coerce_year <- function(x) suppressWarnings(as.integer(as.character(x)))
zscore <- function(x) {
s <- sd(x, na.rm = TRUE)
m <- mean(x, na.rm = TRUE)
if (is.na(s) || s == 0) return(rep(0, length(x)))
(x - m) / s
}
minmax <- function(x) {
rng <- range(x, na.rm = TRUE)
if (diff(rng) == 0) return(rep(0, length(x)))
(x - rng[1]) / (diff(rng) + 1e-9)
}
find_file <- function(base_dir, pattern) {
hits <- list.files(base_dir, pattern = pattern, recursive = TRUE, full.names = TRUE)
if (length(hits) > 0) normalizePath(hits[[1]], winslash = "/", mustWork = FALSE) else NA_character_
}
if (!file.exists(lgii_path)) {
stop("LGII file not found. Checked: ", lgii_path, " and ", lgii_default, ". Place the NASA Excel there or set lgii_path manually.")
}
lgii <- if (grepl("\\.xlsx$", lgii_path, ignore.case = TRUE)) {
lg_raw <- read_excel(lgii_path, sheet = "Data") %>%
janitor::clean_names()
country_col <- intersect(c("iso", "country_iso", "country"), names(lg_raw))
country_col <- if (length(country_col) > 0) country_col[[1]] else NA_character_
gini_col <- intersect(c("gini_weighted", "gini"), names(lg_raw))
gini_col <- if (length(gini_col) > 0) gini_col[[1]] else NA_character_
if (is.na(country_col)) stop("Could not find a country/iso column in LGII.")
lg_raw %>%
mutate(
country_iso = standardize_iso(.data[[country_col]]),
gini = if (!is.na(gini_col)) .data[[gini_col]] else NA_real_
)
} else {
read_csv(lgii_path, show_col_types = FALSE) %>%
janitor::clean_names() %>%
mutate(
country_iso = standardize_iso(coalesce(country_iso, iso, country)),
gini = if ("gini" %in% names(.)) gini else NA_real_
)
}
lgii <- lgii %>%
mutate(
year = coerce_year(year)
) %>%
drop_na(country_iso, year)
glimpse(lgii)
world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf") %>%
mutate(country_iso = toupper(iso_a3)) %>%
filter(country_iso != "-99") %>%
select(country_iso, geometry) %>%
filter(country_iso %in% lgii$country_iso)
if (nrow(world) == 0) stop("No overlap between LGII countries and Natural Earth shapes.")
plot(st_geometry(world))
extract_stat <- function(shapes, raster_path, fun = "mean", band = 1) {
if (!file.exists(raster_path)) {
warning("Missing raster: ", raster_path)
return(tibble(country_iso = shapes$country_iso, value = NA_real_))
}
r <- rast(raster_path)
if (band > nlyr(r)) stop("Band ", band, " not in raster.")
r <- r[[band]]
if (!is.na(crs(r)) && crs(r) != crs(shapes)) {
shapes <- st_transform(shapes, crs(r))
}
# Efficient zonal stats
shapes$id <- seq_len(nrow(shapes))
z <- tryCatch(terra::zonal(r, vect(shapes), fun = fun, na.rm = TRUE), error = function(e) NULL)
if (is.null(z)) {
vals <- terra::extract(r, vect(shapes), fun = match.fun(fun), na.rm = TRUE)[,2]
return(tibble(country_iso = shapes$country_iso, value = vals))
}
vals <- rep(NA_real_, nrow(shapes))
vals[match(z$zone, shapes$id)] <- z[[ncol(z)]]
tibble(country_iso = shapes$country_iso, value = vals)
}
temp_path <- find_file(kaggle_dir, "TEMP.tif$")
pop_path  <- find_file(kaggle_dir, "GHS_POP_E2015_GLOBE_R2019A_54009_250_V1_0\\.tif$")
veg_path  <- find_file(kaggle_dir, "ESACCI-LC-L4-LCCS-Map-300m-P1Y-2015-v2\\.0\\.7\\.tif$")
haz_path  <- find_file(kaggle_dir, "Goode_FinalClassification_19_05pcnt_prj\\.tif$")
gdp_path  <- find_file(kaggle_dir, "GDP_PPP_1990_2015_5arcmin_v2\\.nc$")
cat("Resolved temp_path:", temp_path, "exists:", file.exists(temp_path), "\n")
cat("Resolved pop_path :", pop_path,  "exists:", file.exists(pop_path),  "\n")
cat("Resolved veg_path :", veg_path,  "exists:", file.exists(veg_path),  "\n")
cat("Resolved haz_path :", haz_path,  "exists:", file.exists(haz_path),  "\n")
cat("Resolved gdp_path :", gdp_path,  "exists:", file.exists(gdp_path),  "\n")
if (is.na(temp_path) || !file.exists(temp_path)) stop("Temperature raster not found; ensure TEMP.tif exists under Kaggle Dataset.")
cls
clear
library(tidyverse)
library(readxl)
library(sf)
library(terra)
library(randomForest)
library(jsonlite)
theme_set(theme_minimal())
# Limit terra memory usage to ~80% of available
terraOptions(memfrac = 0.1, parallel = FALSE)
lgii_default <- "data/Nasa Earth Data/spatialecon-lgii-measures-v1-xlsx.xlsx"
lgii_sample <- "data/sample/lgii_sample.csv"  # set use_sample_lgii <- TRUE only if testing
use_sample_lgii <- FALSE
kaggle_dir <- "data/Kaggle Dataset"   # adjust if your folder is named differently (e.g., 'data/Kaggle Data')
if (file.exists(lgii_default)) {
lgii_path <- lgii_default
} else if (use_sample_lgii && file.exists(lgii_sample)) {
lgii_path <- lgii_sample
} else {
stop("LGII Excel not found at ", lgii_default, ". Set the correct path or enable use_sample_lgii for the toy CSV.")
}
lgii_path <- normalizePath(lgii_path, winslash = "/", mustWork = TRUE)
kaggle_dir <- normalizePath(kaggle_dir, winslash = "/", mustWork = TRUE)
cat("Using LGII at:", lgii_path, "\n")
cat("Using Kaggle data at:", kaggle_dir, "\n")
standardize_iso <- function(x) toupper(trimws(as.character(x)))
coerce_year <- function(x) suppressWarnings(as.integer(as.character(x)))
zscore <- function(x) {
s <- sd(x, na.rm = TRUE)
m <- mean(x, na.rm = TRUE)
if (is.na(s) || s == 0) return(rep(0, length(x)))
(x - m) / s
}
minmax <- function(x) {
rng <- range(x, na.rm = TRUE)
if (diff(rng) == 0) return(rep(0, length(x)))
(x - rng[1]) / (diff(rng) + 1e-9)
}
find_file <- function(base_dir, pattern) {
hits <- list.files(base_dir, pattern = pattern, recursive = TRUE, full.names = TRUE)
if (length(hits) > 0) normalizePath(hits[[1]], winslash = "/", mustWork = FALSE) else NA_character_
}
if (!file.exists(lgii_path)) {
stop("LGII file not found. Checked: ", lgii_path, " and ", lgii_default, ". Place the NASA Excel there or set lgii_path manually.")
}
lgii <- if (grepl("\\.xlsx$", lgii_path, ignore.case = TRUE)) {
lg_raw <- read_excel(lgii_path, sheet = "Data") %>%
janitor::clean_names()
country_col <- intersect(c("iso", "country_iso", "country"), names(lg_raw))
country_col <- if (length(country_col) > 0) country_col[[1]] else NA_character_
gini_col <- intersect(c("gini_weighted", "gini"), names(lg_raw))
gini_col <- if (length(gini_col) > 0) gini_col[[1]] else NA_character_
if (is.na(country_col)) stop("Could not find a country/iso column in LGII.")
lg_raw %>%
mutate(
country_iso = standardize_iso(.data[[country_col]]),
gini = if (!is.na(gini_col)) .data[[gini_col]] else NA_real_
)
} else {
read_csv(lgii_path, show_col_types = FALSE) %>%
janitor::clean_names() %>%
mutate(
country_iso = standardize_iso(coalesce(country_iso, iso, country)),
gini = if ("gini" %in% names(.)) gini else NA_real_
)
}
lgii <- lgii %>%
mutate(
year = coerce_year(year)
) %>%
drop_na(country_iso, year)
glimpse(lgii)
world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf") %>%
mutate(country_iso = toupper(iso_a3)) %>%
filter(country_iso != "-99") %>%
select(country_iso, geometry)
plot(st_geometry(world))
extract_stat <- function(shapes, raster_path, fun = "mean", band = 1) {
if (!file.exists(raster_path)) {
warning("Missing raster: ", raster_path)
return(tibble(country_iso = shapes$country_iso, value = NA_real_))
}
r <- rast(raster_path)
if (band > nlyr(r)) stop("Band ", band, " not in raster.")
r <- r[[band]]
if (!is.na(crs(r)) && crs(r) != crs(shapes)) {
shapes <- st_transform(shapes, crs(r))
}
# Efficient zonal stats
shapes$id <- seq_len(nrow(shapes))
z <- tryCatch(terra::zonal(r, vect(shapes), fun = fun, na.rm = TRUE), error = function(e) NULL)
if (is.null(z)) {
vals <- terra::extract(r, vect(shapes), fun = match.fun(fun), na.rm = TRUE)[,2]
return(tibble(country_iso = shapes$country_iso, value = vals))
}
vals <- rep(NA_real_, nrow(shapes))
vals[match(z$zone, shapes$id)] <- z[[ncol(z)]]
tibble(country_iso = shapes$country_iso, value = vals)
}
temp_path <- find_file(kaggle_dir, "TEMP.tif$")
pop_path  <- find_file(kaggle_dir, "GHS_POP_E2015_GLOBE_R2019A_54009_250_V1_0\\.tif$")
veg_path  <- find_file(kaggle_dir, "ESACCI-LC-L4-LCCS-Map-300m-P1Y-2015-v2\\.0\\.7\\.tif$")
haz_path  <- find_file(kaggle_dir, "Goode_FinalClassification_19_05pcnt_prj\\.tif$")
gdp_path  <- find_file(kaggle_dir, "GDP_PPP_1990_2015_5arcmin_v2\\.nc$")
env_static <- world %>%
transmute(country_iso) %>%
left_join(extract_stat(world, temp_path, fun = "mean") %>% rename(temp_celsius = value), by = "country_iso") %>%
left_join(extract_stat(world, pop_path, fun = "sum") %>% rename(population = value), by = "country_iso") %>%
left_join({
if (file.exists(veg_path)) {
r <- rast(veg_path)
if (crs(r) != crs(world)) world_aligned <- st_transform(world, crs(r)) else world_aligned <- world
world_aligned$id <- seq_len(nrow(world_aligned))
# Reclassify to binary vegetation indicator (1 for 10–200)
r_veg <- classify(r, rbind(c(-Inf, 10, 0), c(10, 200, 1), c(200, Inf, 0)))
z <- terra::zonal(r_veg, vect(world_aligned), fun = "mean", na.rm = TRUE)
frac <- rep(NA_real_, nrow(world_aligned))
frac[match(z$zone, world_aligned$id)] <- z$mean
tibble(country_iso = world_aligned$country_iso, vegetation_fraction = frac)
} else {
warning("Missing land cover raster: ", veg_path)
tibble(country_iso = world$country_iso, vegetation_fraction = NA_real_)
}
}, by = "country_iso") %>%
left_join(extract_stat(world, haz_path, fun = mean) %>% rename(hazard_score = value), by = "country_iso") %>%
mutate(
pm25_mean = NA_real_,             # placeholder
precip_mm_month = NA_real_        # placeholder
)
getwd()  # should be .../Impact-of-Environmental-Factors-on-Socioeconomic-Outcomes
file.exists("data/Kaggle Dataset/11_temperature/World_TEMP_GISdata_LTAy_GlobalSolarAtlas-v2_GEOTIFF/World_TEMP_GISdata_LTAy_GlobalSolarAtlas_GEOTIFF/TEMP.tif")
file.exists("data/Kaggle Dataset/5_GHS_POP_E2015_GLOBE_R2019A_54009_250_V1_0/GHS_POP_E2015_GLOBE_R2019A_54009_250_V1_0/GHS_POP_E2015_GLOBE_R2019A_54009_250_V1_0.tif")
source_knitr_chunk <- function() {
kaggle_dir <- normalizePath("data/Kaggle Dataset", winslash = "/", mustWork = TRUE)
find_file <- function(base_dir, pattern) {
hits <- list.files(base_dir, pattern = pattern, recursive = TRUE, full.names = TRUE)
if (length(hits) > 0) normalizePath(hits[[1]], winslash = "/", mustWork = FALSE) else NA_character_
}
temp_path <- find_file(kaggle_dir, "TEMP.tif$")
pop_path  <- find_file(kaggle_dir, "GHS_POP_E2015_GLOBE_R2019A_54009_250_V1_0\\.tif$")
c(temp_path = temp_path, pop_path = pop_path,
temp_exists = file.exists(temp_path), pop_exists = file.exists(pop_path))
}
source_knitr_chunk()
library(tidyverse)
library(readxl)
library(sf)
library(terra)
library(randomForest)
library(jsonlite)
theme_set(theme_minimal())
# Limit terra memory usage and spill to disk
terraOptions(memfrac = 0.1, todisk = TRUE, parallel = FALSE)
lgii_default <- "data/Nasa Earth Data/spatialecon-lgii-measures-v1-xlsx.xlsx"
lgii_sample <- "data/sample/lgii_sample.csv"  # set use_sample_lgii <- TRUE only if testing
use_sample_lgii <- FALSE
kaggle_dir <- "data/Kaggle Dataset"   # adjust if your folder is named differently (e.g., 'data/Kaggle Data')
if (file.exists(lgii_default)) {
lgii_path <- lgii_default
} else if (use_sample_lgii && file.exists(lgii_sample)) {
lgii_path <- lgii_sample
} else {
stop("LGII Excel not found at ", lgii_default, ". Set the correct path or enable use_sample_lgii for the toy CSV.")
}
lgii_path <- normalizePath(lgii_path, winslash = "/", mustWork = TRUE)
kaggle_dir <- normalizePath(kaggle_dir, winslash = "/", mustWork = TRUE)
cat("Using LGII at:", lgii_path, "\n")
cat("Using Kaggle data at:", kaggle_dir, "\n")
standardize_iso <- function(x) toupper(trimws(as.character(x)))
coerce_year <- function(x) suppressWarnings(as.integer(as.character(x)))
zscore <- function(x) {
s <- sd(x, na.rm = TRUE)
m <- mean(x, na.rm = TRUE)
if (is.na(s) || s == 0) return(rep(0, length(x)))
(x - m) / s
}
minmax <- function(x) {
rng <- range(x, na.rm = TRUE)
if (diff(rng) == 0) return(rep(0, length(x)))
(x - rng[1]) / (diff(rng) + 1e-9)
}
find_file <- function(base_dir, pattern) {
hits <- list.files(base_dir, pattern = pattern, recursive = TRUE, full.names = TRUE)
if (length(hits) > 0) normalizePath(hits[[1]], winslash = "/", mustWork = FALSE) else NA_character_
}
if (!file.exists(lgii_path)) {
stop("LGII file not found. Checked: ", lgii_path, " and ", lgii_default, ". Place the NASA Excel there or set lgii_path manually.")
}
lgii <- if (grepl("\\.xlsx$", lgii_path, ignore.case = TRUE)) {
lg_raw <- read_excel(lgii_path, sheet = "Data") %>%
janitor::clean_names()
country_col <- intersect(c("iso", "country_iso", "country"), names(lg_raw))
country_col <- if (length(country_col) > 0) country_col[[1]] else NA_character_
gini_col <- intersect(c("gini_weighted", "gini"), names(lg_raw))
gini_col <- if (length(gini_col) > 0) gini_col[[1]] else NA_character_
if (is.na(country_col)) stop("Could not find a country/iso column in LGII.")
lg_raw %>%
mutate(
country_iso = standardize_iso(.data[[country_col]]),
gini = if (!is.na(gini_col)) .data[[gini_col]] else NA_real_
)
} else {
read_csv(lgii_path, show_col_types = FALSE) %>%
janitor::clean_names() %>%
mutate(
country_iso = standardize_iso(coalesce(country_iso, iso, country)),
gini = if ("gini" %in% names(.)) gini else NA_real_
)
}
lgii <- lgii %>%
mutate(
year = coerce_year(year)
) %>%
drop_na(country_iso, year)
glimpse(lgii)
world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf") %>%
mutate(country_iso = toupper(iso_a3)) %>%
filter(country_iso != "-99") %>%
select(country_iso, geometry)
plot(st_geometry(world))
extract_stat <- function(shapes, raster_path, fun = "mean", band = 1) {
if (!file.exists(raster_path)) {
warning("Missing raster: ", raster_path)
return(tibble(country_iso = shapes$country_iso, value = NA_real_))
}
r <- rast(raster_path)
if (band > nlyr(r)) stop("Band ", band, " not in raster.")
r <- r[[band]]
if (!is.na(crs(r)) && crs(r) != crs(shapes)) {
shapes <- st_transform(shapes, crs(r))
}
# Efficient zonal stats
shapes$id <- seq_len(nrow(shapes))
z <- tryCatch(terra::zonal(r, vect(shapes), fun = fun, na.rm = TRUE), error = function(e) NULL)
if (is.null(z)) {
vals <- terra::extract(r, vect(shapes), fun = match.fun(fun), na.rm = TRUE)[,2]
return(tibble(country_iso = shapes$country_iso, value = vals))
}
vals <- rep(NA_real_, nrow(shapes))
vals[match(z$zone, shapes$id)] <- z[[ncol(z)]]
tibble(country_iso = shapes$country_iso, value = vals)
}
temp_path <- find_file(kaggle_dir, "TEMP.tif$")
pop_path  <- find_file(kaggle_dir, "GHS_POP_E2015_GLOBE_R2019A_54009_250_V1_0\\.tif$")
veg_path  <- find_file(kaggle_dir, "ESACCI-LC-L4-LCCS-Map-300m-P1Y-2015-v2\\.0\\.7\\.tif$")
haz_path  <- find_file(kaggle_dir, "Goode_FinalClassification_19_05pcnt_prj\\.tif$")
gdp_path  <- find_file(kaggle_dir, "GDP_PPP_1990_2015_5arcmin_v2\\.nc$")
# Normalize to short (8.3) paths to avoid Windows path quirks
to_short <- function(p) if (is.na(p)) NA_character_ else shortPathName(p)
temp_path <- to_short(temp_path)
pop_path  <- to_short(pop_path)
veg_path  <- to_short(veg_path)
haz_path  <- to_short(haz_path)
gdp_path  <- to_short(gdp_path)
cat("Resolved temp_path:", temp_path, "exists:", file.exists(temp_path), "\n")
cat("Resolved pop_path :", pop_path,  "exists:", file.exists(pop_path),  "\n")
cat("Resolved veg_path :", veg_path,  "exists:", file.exists(veg_path),  "\n")
cat("Resolved haz_path :", haz_path,  "exists:", file.exists(haz_path),  "\n")
cat("Resolved gdp_path :", gdp_path,  "exists:", file.exists(gdp_path),  "\n")
if (is.na(temp_path) || !file.exists(temp_path)) stop("Temperature raster not found or unreadable; ensure TEMP.tif exists and the path is accessible.")
library(tidyverse)
library(readxl)
library(sf)
library(terra)
library(randomForest)
library(jsonlite)
theme_set(theme_minimal())
# Limit terra memory usage and spill to disk
terraOptions(memfrac = 0.1, todisk = TRUE, parallel = FALSE)
lgii_default <- "data/Nasa Earth Data/spatialecon-lgii-measures-v1-xlsx.xlsx"
lgii_sample <- "data/sample/lgii_sample.csv"  # set use_sample_lgii <- TRUE only if testing
use_sample_lgii <- FALSE
kaggle_dir <- "data/Kaggle Dataset"   # adjust if your folder is named differently (e.g., 'data/Kaggle Data')
if (file.exists(lgii_default)) {
lgii_path <- lgii_default
} else if (use_sample_lgii && file.exists(lgii_sample)) {
lgii_path <- lgii_sample
} else {
stop("LGII Excel not found at ", lgii_default, ". Set the correct path or enable use_sample_lgii for the toy CSV.")
}
lgii_path <- normalizePath(lgii_path, winslash = "/", mustWork = TRUE)
kaggle_dir <- normalizePath(kaggle_dir, winslash = "/", mustWork = TRUE)
cat("Using LGII at:", lgii_path, "\n")
cat("Using Kaggle data at:", kaggle_dir, "\n")
standardize_iso <- function(x) toupper(trimws(as.character(x)))
coerce_year <- function(x) suppressWarnings(as.integer(as.character(x)))
zscore <- function(x) {
s <- sd(x, na.rm = TRUE)
m <- mean(x, na.rm = TRUE)
if (is.na(s) || s == 0) return(rep(0, length(x)))
(x - m) / s
}
minmax <- function(x) {
rng <- range(x, na.rm = TRUE)
if (diff(rng) == 0) return(rep(0, length(x)))
(x - rng[1]) / (diff(rng) + 1e-9)
}
find_file <- function(base_dir, pattern) {
hits <- list.files(base_dir, pattern = pattern, recursive = TRUE, full.names = TRUE)
if (length(hits) > 0) normalizePath(hits[[1]], winslash = "/", mustWork = FALSE) else NA_character_
}
if (!file.exists(lgii_path)) {
stop("LGII file not found. Checked: ", lgii_path, " and ", lgii_default, ". Place the NASA Excel there or set lgii_path manually.")
}
lgii <- if (grepl("\\.xlsx$", lgii_path, ignore.case = TRUE)) {
lg_raw <- read_excel(lgii_path, sheet = "Data") %>%
janitor::clean_names()
country_col <- intersect(c("iso", "country_iso", "country"), names(lg_raw))
country_col <- if (length(country_col) > 0) country_col[[1]] else NA_character_
gini_col <- intersect(c("gini_weighted", "gini"), names(lg_raw))
gini_col <- if (length(gini_col) > 0) gini_col[[1]] else NA_character_
if (is.na(country_col)) stop("Could not find a country/iso column in LGII.")
lg_raw %>%
mutate(
country_iso = standardize_iso(.data[[country_col]]),
gini = if (!is.na(gini_col)) .data[[gini_col]] else NA_real_
)
} else {
read_csv(lgii_path, show_col_types = FALSE) %>%
janitor::clean_names() %>%
mutate(
country_iso = standardize_iso(coalesce(country_iso, iso, country)),
gini = if ("gini" %in% names(.)) gini else NA_real_
)
}
lgii <- lgii %>%
mutate(
year = coerce_year(year)
) %>%
drop_na(country_iso, year)
glimpse(lgii)
world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf") %>%
mutate(country_iso = toupper(iso_a3)) %>%
filter(country_iso != "-99") %>%
select(country_iso, geometry)
plot(st_geometry(world))
extract_stat <- function(shapes, raster_path, fun = "mean", band = 1) {
if (!file.exists(raster_path)) {
warning("Missing raster: ", raster_path)
return(tibble(country_iso = shapes$country_iso, value = NA_real_))
}
r <- rast(raster_path)
if (band > nlyr(r)) stop("Band ", band, " not in raster.")
r <- r[[band]]
if (!is.na(crs(r)) && crs(r) != crs(shapes)) {
shapes <- st_transform(shapes, crs(r))
}
# Efficient zonal stats
shapes$id <- seq_len(nrow(shapes))
z <- tryCatch(terra::zonal(r, vect(shapes), fun = fun, na.rm = TRUE), error = function(e) NULL)
if (is.null(z)) {
vals <- terra::extract(r, vect(shapes), fun = match.fun(fun), na.rm = TRUE)[,2]
return(tibble(country_iso = shapes$country_iso, value = vals))
}
vals <- rep(NA_real_, nrow(shapes))
vals[match(z$zone, shapes$id)] <- z[[ncol(z)]]
tibble(country_iso = shapes$country_iso, value = vals)
}
temp_path <- find_file(kaggle_dir, "TEMP.tif$")
pop_path  <- find_file(kaggle_dir, "GHS_POP_E2015_GLOBE_R2019A_54009_250_V1_0\\.tif$")
veg_path  <- find_file(kaggle_dir, "ESACCI-LC-L4-LCCS-Map-300m-P1Y-2015-v2\\.0\\.7\\.tif$")
haz_path  <- find_file(kaggle_dir, "Goode_FinalClassification_19_05pcnt_prj\\.tif$")
gdp_path  <- find_file(kaggle_dir, "GDP_PPP_1990_2015_5arcmin_v2\\.nc$")
list_and_normalize <- function(dir, pattern, label) {
hits <- list.files(dir, pattern = pattern, recursive = TRUE, full.names = TRUE)
cat(label, "candidates found:", length(hits), "\n")
if (length(hits) == 0) return(NA_character_)
cat(paste0("  [1] ", hits[1], "\n"))
tryCatch(normalizePath(hits[1], winslash = "/", mustWork = TRUE), error = function(e) NA_character_)
}
temp_path <- list_and_normalize(kaggle_dir, "TEMP.tif$", "TEMP")
pop_path  <- list_and_normalize(kaggle_dir, "GHS_POP_E2015_GLOBE_R2019A_54009_250_V1_0\\.tif$", "POP")
veg_path  <- list_and_normalize(kaggle_dir, "ESACCI-LC-L4-LCCS-Map-300m-P1Y-2015-v2\\.0\\.7\\.tif$", "VEG")
haz_path  <- list_and_normalize(kaggle_dir, "Goode_FinalClassification_19_05pcnt_prj\\.tif$", "HAZ")
gdp_path  <- list_and_normalize(kaggle_dir, "GDP_PPP_1990_2015_5arcmin_v2\\.nc$", "GDP")
cat("Resolved temp_path:", temp_path, "exists:", file.exists(temp_path), "\n")
cat("Resolved pop_path :", pop_path,  "exists:", file.exists(pop_path),  "\n")
cat("Resolved veg_path :", veg_path,  "exists:", file.exists(veg_path),  "\n")
cat("Resolved haz_path :", haz_path,  "exists:", file.exists(haz_path),  "\n")
cat("Resolved gdp_path :", gdp_path,  "exists:", file.exists(gdp_path),  "\n")
if (is.na(temp_path) || !file.exists(temp_path)) stop("Temperature raster not found or unreadable; ensure TEMP.tif exists and the path is accessible.")
print(temp_path)
file.exists(temp_path)
